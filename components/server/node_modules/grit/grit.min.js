/**
 * Grit v0.2.5
 * Copyright (C) 2011 Matt Baker
 * http://github.com/reissbaker
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.

 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License at <http://www.gnu.org/licenses/> for 
 * details.
 */(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n;m=function(a,b){return exports!==n&&module!==n&&require!==n?a():b()},g=m(function(){return require("events").EventEmitter},function(){return window.EventEmitter}),i=function(a){return Array.prototype.slice.call(a,0)},j=function(a,b){var c,d;c={};for(d in a)a.hasOwnProperty(d)&&(c[d]=a[d]);for(d in b)b.hasOwnProperty(d)&&(c[d]=b[d]);return c},l=function(a){var b=0;return a=i(a),{parsed:{},optional:function(c,d,e){var f,g,h;return f=!0,g=a[b],h=d,typeof e=="function"?f=e(g,a):(e.hasOwnProperty("type")&&(f=typeof g===e.type),e.hasOwnProperty("instance")&&(f=f&&g instanceof e.instance)),f&&(b++,h=g),this.parsed[c]=h,this},required:function(c){return this.parsed[c]=a[b],b++,this}}},k=function(a){if(!a.hasOwnProperty("hasList")||!a.hasList)a.hasList={},a.hasListLength=0;if(!a.hasOwnProperty("reqs")||!a.reqs)a.reqs={},a.reqsLength=0},b="propertyChange",a=function(){var a,c,d,e,f,h,i,m,o,p,q;g.call(this),p=l(arguments).optional("properties",{},{type:"object"}).optional("isNew",!0,{type:"boolean"}).optional("finishedCreating",function(){},{type:"function"}).parsed,a={},q=!0,h=function(b){var c;if(!b.constructor.hasOwnProperty("reqs")||!b.constructor.reqs)return!0;for(c in b.constructor.reqs)if(b.constructor.reqs.hasOwnProperty(c)&&!a.hasOwnProperty(c))return!1;return!0},f=function(a,b,c){var d,e,f,g;if(!a.constructor.hasOwnProperty("validations")||!a.constructor.validations)return!0;if(!a.constructor.validations.hasOwnProperty(b)||!a.constructor.validations[b])return!0;d=a.constructor.validations[b];for(f=0,g=d.length;f<g;f++)if(!d[f](c))return!1;return!0},e=function(c,d,e,f,g){var h;f===n||!f?c.get(d,function(f,i){a[d]=e,q||(h="change:"+d,c.emit(h,c,i,e),c.emit(b,h,c,i,e)),q||c.constructor.update(c,a,d,g)}):(a[d]=e,q||c.constructor.update(c,a,d,g))},this.get=function(b,c){a.hasOwnProperty(b)?c(null,a[b]):this.constructor.read(this,a,b,function(d,e){d||(a[b]=e),c(d,e)})},this.loadAll=function(b){var c,d,e,f,g,h,i;h=this,k(this.constructor),c=this.constructor.hasListLength+this.constructor.reqsLength,i=j(this.constructor.hasList,this.constructor.reqs),f=!1,g=function(a){a===n&&(a=null),f||(f=!0,b!==n&&b(a))},e=function(b){h.constructor.read(h,a,b,function(d,e){d?g(d):(a[b]=e,c--,c===0&&g())})};for(d in i)this.constructor.hasList.hasOwnProperty(d)&&(a.hasOwnProperty(d)||e(d));c===0&&g()},this.set=function(){var a=l(arguments).required("name").required("value").optional("silent",!1,{type:"boolean"}).optional("finished",function(){},{type:"function"}).parsed,b=f(this,a.name,a.value)&&h(this);b?e(this,a.name,a.value,a.silent,a.finished):a.finished("Error: "+a.value+" is an invalid value for "+a.name+" of "+this)},this.destroy=function(b){b===n&&(b=function(){}),this.constructor.destroy(this,a,b)};if(this.constructor.hasOwnProperty("defaultsHash")&&p.isNew)for(c in this.constructor.defaultsHash)this.constructor.defaultsHash.hasOwnProperty(c)&&!p.properties.hasOwnProperty(c)&&(p.properties[c]=this.constructor.defaultsHash[c]);d=!0;if(this.constructor.hasOwnProperty("reqs"))for(c in this.constructor.reqs)if(!p.properties.hasOwnProperty(c)||!f(this,c,p.properties[c])){d=!1;break}if(d)for(c in p.properties)p.properties.hasOwnProperty(c)&&e(this,c,p.properties[c],q,function(){});this.constructor.create(this,a,p.finishedCreating),q=p.isNew=!1},a.prototype=new g,a.prototype.constructor=a,a.extend=function(b){b.prototype=new a,b.prototype.constructor=b;for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},a.create=function(a,b,c){c!==n&&c(null)},a.read=function(a,b,c,d){d("Error: no "+c+" property could be read",null)},a.update=function(a,b,c,d){d(null)},a.destroy=function(a,b,c){c(null)},a.find=function(a,b){b("Error: find must be overridden.",null)},a.defaults=function(a){this.hasOwnProperty("defaultsHash")||(this.defaultsHash={});for(var b in a)a.hasOwnProperty(b)&&(this.defaultsHash[b]=a[b])},a.required=function(){var a,b;a=i(arguments),k(this);for(b=0;b<a.length;b++)this.reqs[a[b]]=!0,this.reqsLength++;if(a.length===1)return a[0]},a.unrequired=function(){var a,b;a=i(arguments);if(!this.hasOwnProperty("reqs"))return;for(b=0;b<a.length;b++)this.reqs.hasOwnProperty(a[b])&&(delete this.reqs[a[b]],this.reqsLength--);if(a.length===1)return a[0]},a.has=function(){var a,b;a=i(arguments),k(this);for(b=0;b<a.length;b++)this.hasList[a[b]]=!0,this.hasListLength++;if(a.length===1)return a[0]},a.lacks=function(){var a,b;a=i(arguments);if(!this.hasOwnProperty("hasList"))return;for(b=0;b<a.length;b++)this.hasList.hasOwnProperty(a[b])&&(delete this.hasList[a[b]],this.hasListLength--);if(a.length===1)return a[0]},a.validate=function(a,b){this.hasOwnProperty("validations")||(this.validations={}),this.validations.hasOwnProperty(a)||(this.validations[a]=[]),this.validations[a].push(b)},a.removeValidation=function(a,b){var c,d,e;if(!this.hasOwnProperty("validations"))return;if(this.validations.hasOwnProperty(a)){c=this.validations[a];for(d=0,e=c.length;d<e;d++)if(c[d]===b){c.splice(d,1);break}c.length===0&&delete this.validations[a]}},c=function(a,b){this.load=function(c){b.find(a,c)}},d=function(a,b){return new c(a,b)},e=function(a){this.element=a},f=function(d){var f,h,i,j,k,m,o,p,q,r,s;g.call(this),s=this,d===n?f=[]:f=d.splice(0),h=function(a,b){a instanceof c?a.load(b):b(null,a)},i=function(a,b,c){b?h(a.element,function(b,d){!b&&d&&(a.element=d),typeof c=="function"&&c(b,d)}):c(null,a.element)},j=function(a,b){a.emit("add",b)},k=function(a,b){a.emit("remove",b)},r=function(a,c,d,e){s.emit(a,c,d,e),s.emit(b,a,c,d,e)},q=function(c,d,e,f,g){var h=e.element;g(e),h instanceof a&&h.on(b,r),j(c,h),i(e,d,function(a,b){f(a,b)})},o=function(c,d,e,g,h){var j,l;if(f.length<=0){g("Error: nothing to "+d,null);return}j=h(),l=j.element,l instanceof a&&l.removeListener(b,r),k(c,l),i(j,e,function(a,b){g(a,b)})},m=function(a,b,c){return function(){var d=l(arguments).optional("options",{forceLoad:!1},{type:"object"}).required("callback").parsed;o(a,b,d.options.forceLoad,d.callback,c)}},p=function(a,b){return function(){var c=l(arguments).optional("options",{forceLoad:!1},function(a,b){return b.length>1&&typeof a=="object"}).required("element").optional("callback",function(){},{type:"function"}).parsed;q(a,c.options.forceLoad,new e(c.element),c.callback,b)}},this.push=p(this,function(a){f.push(a)}),this.pop=m(this,"pop",function(){return f.pop()}),this.pushFront=p(this,function(a){f=[a].concat(f)}),this.popFront=m(this,"popFront",function(){return f.splice(0,1)[0]}),this.set=function(){var a,b,c,d,g,h,i;a=this,b=l(arguments).required("index").optional("options",{forceLoad:!1},function(a,b){var c=b.length;return c>2&&(c===4?!0:typeof b[c-1]!="function")}).required("element").optional("callback",function(){},{type:"function"}).parsed,c=b.index,g=new e(b.element),h=function(a){f[c]=a},f[c]!==n&&f[c]?(i=f[c],o(this,"set",b.options.forceLoad,function(c,d){q(a,b.options.forceLoad,g,function(a,c){b.callback(a,c,d)},h)},function(){return i})):q(this,b.options.forceLoad,g,b.callback,h)},this.remove=function(){var a,b,c,d,e,g;a=this,b=l(arguments).required("something").optional("options",{forceLoad:!1,inOrder:!0},{type:"object"}).optional("callback",function(){},{type:"function"}).parsed;if(typeof b.something=="number")c=b.something;else{d=b.something,c=-1,this.forEach(b.options,function(a,b,e){b===d&&(c=e)},function(){c===-1?b.callback("Error: model not found",null):a.remove(c,b.callback)});return}o(this,"remove",b.options.forceLoad,b.callback,function(){return f.splice(c,1)[0]})},this.at=function(){var a=l(arguments).required("index").optional("options",{forceLoad:!1},{type:"object"}).optional("callback",function(){},{type:"function"}).parsed;i(f[a.index],a.options.forceLoad,a.callback)},this.length=function(){return f.length},this.forEach=function(){var a,b,c,d,e,g;g=0,a=l(arguments).optional("options",{forceLoad:!1,inOrder:!1},{type:"object"}).required("fn").optional("callback",function(){},{type:"function"}).parsed,c=function(a,b,d,e){a<f.length?i(f[a],b.forceLoad,function(f,g){d(f,g,a),c(a+1,b,d,e)}):e()},d=function(a,b,c,d){i(f[a],b.forceLoad,function(b,e){g--,c(b,e,a),g===0&&d()})};if(!a.options.inOrder)if(f.length>0){g=f.length;for(e=0;e<f.length;e++)d(e,a.options,a.fn,a.callback)}else a.callback();else c(0,a.options,a.fn,a.callback)}},f.prototype=new g,f.prototype.constructor=f,h={Model:a,Collection:f,placeholder:d},m(function(){module.exports=h},function(){window.grit=h})})();